<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      background: #1e1e1e;
      overflow: hidden;
    }
    #container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .panel {
      height: 100%;
      display: flex;
      flex-direction: column;
      min-width: 100px;
      overflow: hidden;
    }
    #panel-left {
      flex: 1;
    }
    #panel-right {
      flex: 1;
    }
    .divider {
      width: 6px;
      background: #2d2d2d;
      cursor: col-resize;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .divider:hover,
    .divider.dragging {
      background: #444;
    }
    .panel-header {
      padding: 4px 8px;
      background: #2d2d2d;
      color: #888;
      font-family: monospace;
      font-size: 11px;
      border-bottom: 1px solid #444;
    }
    .terminal-container {
      flex: 1;
      padding: 4px;
      overflow: hidden;
    }
    #status {
      position: fixed;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      z-index: 100;
    }
    #status.connecting { background: #f59e0b; color: #000; }
    #status.connected { background: #10b981; color: #fff; }
    #status.disconnected { background: #ef4444; color: #fff; }
    #status.error { background: #ef4444; color: #fff; }
    #user-info {
      position: fixed;
      top: 8px;
      left: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      border-radius: 4px;
      background: #2d2d2d;
      font-family: monospace;
      font-size: 12px;
      color: #888;
      z-index: 100;
    }
    #user-info img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    #user-info a {
      color: #888;
      text-decoration: none;
    }
    #user-info a:hover {
      color: #d4d4d4;
    }
  </style>
</head>
<body>
  <div id="user-info"></div>
  <div id="status" class="connecting">Connecting...</div>
  <div id="container">
    <div id="panel-left" class="panel">
      <div class="panel-header">Terminal (read/write)</div>
      <div id="terminal-left" class="terminal-container"></div>
    </div>
    <div id="divider" class="divider"></div>
    <div id="panel-right" class="panel">
      <div class="panel-header">Mirror (read-only)</div>
      <div id="terminal-right" class="terminal-container"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-unicode11@0.8.0/lib/addon-unicode11.min.js"></script>
  <script>
    // Load user info
    fetch('/auth/status')
      .then(res => res.json())
      .then(data => {
        const userInfo = document.getElementById('user-info');
        if (data.authenticated && data.user) {
          userInfo.innerHTML = `
            <img src="${data.user.avatar_url}" alt="${data.user.login}">
            <span>${data.user.login}</span>
            <a href="#" onclick="logout(); return false;">logout</a>
          `;
        }
      })
      .catch(() => {});

    function logout() {
      fetch('/auth/logout', { method: 'POST' })
        .then(() => window.location.href = '/login')
        .catch(() => {});
    }

    // Resizable panels
    (function() {
      const container = document.getElementById('container');
      const divider = document.getElementById('divider');
      const panelLeft = document.getElementById('panel-left');
      const panelRight = document.getElementById('panel-right');
      let isDragging = false;

      divider.addEventListener('mousedown', function(e) {
        isDragging = true;
        divider.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;

        const containerRect = container.getBoundingClientRect();
        const containerWidth = containerRect.width;
        const dividerWidth = divider.offsetWidth;
        const minWidth = 100;

        let leftWidth = e.clientX - containerRect.left;
        leftWidth = Math.max(minWidth, Math.min(leftWidth, containerWidth - minWidth - dividerWidth));

        const leftPercent = (leftWidth / containerWidth) * 100;
        const rightPercent = ((containerWidth - leftWidth - dividerWidth) / containerWidth) * 100;

        panelLeft.style.flex = 'none';
        panelRight.style.flex = 'none';
        panelLeft.style.width = leftPercent + '%';
        panelRight.style.width = rightPercent + '%';

        // Trigger resize event for terminals to refit
        window.dispatchEvent(new Event('resize'));
      });

      document.addEventListener('mouseup', function() {
        if (isDragging) {
          isDragging = false;
          divider.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    })();
  </script>
  <script src="/terminal.js"></script>
</body>
</html>
